## 💡 프로젝트 개요

- 간편결제의 기본 기능을 구현하는 프로젝트입니다.
- 멤버십, 결제, 계좌, 정산 등의 서비스를 구현하고, 서비스 분리로 인해 발생하는 문제를 파악하고 해결합니다.
- 도메인 분해와 마이크로서비스 통신, 트랜잭션 처리, 데이터 조회, API 게이트웨이 등 실제 운영 환경을 고려한 다양한 설계 패턴을 적용합니다.

## 💡 MiniPay 프로젝트 설계 및 아키텍처 패턴 정리

### 1. 도메인 분해: 책임 기반의 명확한 경계 설정
- `Bounded Context` 개념에 맞춰 도메인을 분리하고 정의함 (→ 도메인 식별 작업 참고)
- 단일 책임 원칙(`SRP`), 공동 폐쇄 원칙(`CCP`)을 기반으로 비즈니스를 분해
- 서비스 분리를 통해 서비스 규모가 확장되더라도 각 도메인이 독립성과 자율성을 갖도록 구조화함 -> `Business Capability`가 높아지고, 각 도메인의 변화가 타 도메인에 영향을 최소화하도록 구성

### 2. 서비스 간 통신: 비즈니스 특성에 따른 호출 방식

- 서비스를 분리하면서 Microservice간 통신이 중요하게 작용함 -> 항상 Network 통신 발생
- 동기 Sync (`HTTP`) / 비동기 Async (`Kafka`, `Axon Framwork`) 중 비즈니스 특성에 맞게 적절한 패턴 사용
- 통신 실패 시를 대비한 재시도, Fallback 로직 작성, 멱등성 처리 구현으로 안정성 강화
- 메시지 기반의 비동기 통신에서는 중복 소비에 대비한 멱등 처리 구현

### 3. 서비스 간 트랜잭션: SAGA 패턴 적용

- 서비스가 독립적으로 구성되면서 분산 트랜잭션 문제가 발생하게 됨
- 이를 해결하기 위해 다음 두 가지 `SAGA` 패턴을 적용
   - Choreography-Based Saga: Kafka 기반 이벤트 흐름을 통해 서비스 간 상태를 공유
   - Orchestration-Based Saga: Axon Server & Framework를 통해 중앙 조정 방식으로 트랜잭션 관리
 
#### 📌 Axon Framework 사용 후기

- Axon Framework은 써보니까 장점보다는 단점이 많은 것 같음
- 일단 기술 자체가 성숙하지 않은 것이 가장 큰 단점 (레퍼런스가 잘 보이지 않음)
- 제약사항이 많은 듯? Orchestration 주체로 Axon Server를 제공하는데, 유용한 기능을 쓰려면 결제를 해야하고 전문 인력도 필요할 것으로 보임
- 무엇보다 Axon Framwork라서 Framework에서 요구하는 제약사항들이 있는데, 불편한 점들이 있음. 예를 들면 Saga에 필요한 Command 객체들은 같은 패키지 경로를 가져야 하는데, 이게 관리 비용 증가로 이어질 가능성이 높아 보임.

### 4. 데이터 쿼리 최적화: CQRS & API Aggregation

- 각 서비스가 독립 DB를 갖기 때문에 복합 쿼리에 한계가 있음
- 이를 해결하기 위해 두 가지 패턴을 활용
	- `API Aggregation`: 여러 서비스의 API를 통합해 데이터를 조합
	- `CQRS`:
	- 데이터 변경 이벤트가 발생하면 Consumer에서 데이터를 조합한 후 실시간으로 DynamoDB에 저장
	- 예: 멤버 머니 충전 이벤트 발생 → 멤버별/지역별/전체 머니 잔액을 DynamoDB에 업데이트
- Query 특성에 따라 Query 용 DB 선택이 가장 중요할 것 같음

### 5. API 단일 진입점: API Gateway

- `API Gateway`를 통해 외부 요청의 단일 진입점을 제공
- 인증/인가, 로깅, 응답 포맷 통일 등의 공통 처리 로직을 Gateway에서 처리
- Spring WebFlux + Spring Cloud Gateway 기반으로 구현하여 비동기 처리 성능을 확보

## 💡 도메인 식별

1. 머니란 무엇인가? (카카오머니, 쿠페이머니, 네이버페이 머니) 
   - 머니는 단순히 충전금액이면서, 카카오라는 법인의 계좌에 쌓이는 돈
   - 예를 들어, 내가 카카오머니를 충전한다는 의미는 내 은행 계좌의 돈을 빼서 카카오 법인 계좌에 입금 하는 행위이다. 나의 카카오머니는 단순히 DB에 update된 돈(머니)
2. 머니는 왜 10,000원 이상 충전해야 하는가?
   - 카카오페이 같은걸 보면, 한번 충전할 때 10,000원으로 충전되는 걸 볼 수 있다.
   - 이는 펌뱅킹 특성 때문! (수수료 문제)
3. 펌뱅킹은 무엇인가?
   - 은행이 아닌 기업이나 단체에서 은행의 전산 시스템을 연결하여 이체, 계좌 조회 등의 서비스를 이용하는 것 (B2B)
   - 대규모 금융 거래에 이용된다. (급여 이체, 계좌 조회, 정산 업무)
   - 실시간, 비실시간(batch) 처리 모두 가능하다.
   - 오픈뱅킹과 비교되는데, 펌뱅킹은 전용망을 구성해 보안과 안정성이 높다. (그래서 간편결제 서비스마다 이용가능한 은행이 조금씩 다르다.)
   - 보통 입/출금 건마다 수수료가 지불되기 때문에 충전금액이 최소 10,000원으로 고정된 경우가 많다.
4. 송금은 무엇인가?
   - User to User의 경우 단순히 충전 금액(머니)의 이동 트랜잭션. 즉, A유저의 잔액을 -update, B유저의 잔액을 +update (이 경우 법인 계좌의 돈은 그대로이다.)
   - 만약, 금액이 부족하면 충전 후 송금 (이 때도 최소 10,000원 이상)
   - User to 일반 은행의 경우 머니를 -update하고, 실제 카카오 법인계좌에서 은행 계좌로 금액을 이동시킨다. (펌뱅킹 이용)
5. 결제는 무엇인가?
   - 카카오 머니를 이용해 교촌치킨에서 결제를 한다는 의미는?
   - User의 머니를 -update하고, 전표를 생성한다!
   - 이 전표는 나중에 일괄 처리(batch)한다. -> 정산한다.
6. 정산은 무엇인가?
   - 생성된 전표로 돈을 정리하는 행위
   - 수수료, 이벤트 등 고려
   - 정산주기가 길수록 회사에 유리할 듯? -> 법인계좌에 돈이 오래 머무르니까
